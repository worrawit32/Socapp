<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soc App - ระบบจัดการ SOC ที่เกิดขึ้น</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jQuery (CDN) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- jQuery Validate (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/localization/messages_th.min.js"></script>

  <!-- SweetAlert2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Loading Overlay (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

  <!-- DataTables (CDN) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.8/r-3.0.2/datatables.min.css"/>
  <script src="https://cdn.datatables.net/v/bs5/dt-2.0.8/r-3.0.2/datatables.min.js"></script>

  <!-- Thai fonts & base style -->
  <style>
    html, body { font-family: ui-sans-serif, system-ui, -apple-system, 'Prompt', 'Sarabun', 'Roboto', 'Segoe UI', Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .tab-active { border-bottom: 3px solid #7F00FF; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-6 text-center">
      <div class="text-3xl font-extrabold tracking-wide select-none">SOC APP</div>
      <div class="text-gray-600 mt-2">Soc App ระบบจัดการ Soc ที่เกิดขึ้น</div>
    </div>
  </header>

  <!-- Nav Tabs -->
  <nav class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4">
      <ul class="flex gap-6 py-3" id="tabs">
        <!-- Dashboard -->
        <li>
          <button data-target="#tab-dashboard" class="tab-btn flex items-center gap-2 px-3 py-2 hover:text-indigo-600" aria-label="Dashboard">
            <!-- Icon -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="#6366F1" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            <span>Dashboard</span>
          </button>
        </li>
        <!-- รายการตรวจเช็ค soc -->
        <li>
          <button data-target="#tab-list" class="tab-btn flex items-center gap-2 px-3 py-2 hover:text-indigo-600" aria-label="รายการตรวจเช็ค soc">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="#22C55E" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 7h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z"/>
              <path d="M4 3h16a1 1 0 0 1 1 1v16l-4-3H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
            </svg>
            <span>รายการตรวจเช็ค soc</span>
          </button>
        </li>
        <!-- ล็อคอิน Admin -->
        <li class="ml-auto">
          <button data-target="#tab-admin" class="tab-btn flex items-center gap-2 px-3 py-2 hover:text-indigo-600" aria-label="ล็อคอินเข้าสู่ระบบ admin">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="#F59E0B" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2a5 5 0 0 0-5 5v2H5a3 3 0 0 0-3 3v7h20v-7a3 3 0 0 0-3-3h-2V7a5 5 0 0 0-5-5zM9 7a3 3 0 1 1 6 0v2H9V7z"/>
            </svg>
            <span>ล็อคอินเข้าสู่ระบบ admin</span>
          </button>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-6xl mx-auto px-4 py-6">

      <!-- Dashboard Tab -->
      <section id="tab-dashboard" class="tab-panel">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-2xl p-6 shadow-lg text-white" style="background: linear-gradient(135deg,#7F00FF,#E100FF)">
            <div class="text-sm opacity-90">จำนวนการตรวจเช็ครวม</div>
            <div class="text-3xl font-bold mt-2" id="card-total">0</div>
          </div>
          <div class="rounded-2xl p-6 shadow-lg text-white" style="background: linear-gradient(135deg,#0EA5E9,#22D3EE)">
            <div class="text-sm opacity-90">รอดำเนินการ</div>
            <div class="text-3xl font-bold mt-2" id="card-pending">0</div>
          </div>
          <div class="rounded-2xl p-6 shadow-lg text-white" style="background: linear-gradient(135deg,#10B981,#34D399)">
            <div class="text-sm opacity-90">เสร็จสิ้นแล้ว</div>
            <div class="text-3xl font-bold mt-2" id="card-done">0</div>
          </div>
        </div>

        <!-- Top 5 ชั้น -->
        <div class="mt-6">
          <div class="rounded-xl bg-white shadow-lg p-6">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Top 5 ชั้นที่เกิด SOC มากที่สุด</h3>
              <button id="btn-download-xlsx" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">
                ดาวน์โหลด Excel (Google Drive)
              </button>
            </div>
            <div class="mt-4 text-sm text-gray-500">* แสดงผลแนว Data Studio (สรุปอันดับจากข้อมูลบนตาราง)</div>
            <ol id="top5" class="mt-4 list-decimal pl-6 text-gray-700 space-y-1"></ol>
          </div>
        </div>

        <!-- รายการตรวจเช็ค soc (Table) -->
        <div class="mt-6 rounded-xl bg-white shadow-lg p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <h3 class="text-lg font-semibold">รายการตรวจเช็ค soc</h3>
            <div class="flex items-center gap-2">
              <select id="date-filter" class="border rounded-lg px-3 py-2 text-sm">
                <option value="all">ทั้งหมด</option>
                <option value="day">รายวัน</option>
                <option value="week">รายสัปดาห์</option>
                <option value="month">รายเดือน</option>
              </select>
              <input type="date" id="date-anchor" class="border rounded-lg px-3 py-2 text-sm"/>
            </div>
          </div>
          <div class="mt-4 overflow-x-auto">
            <table id="socTable" class="min-w-full text-sm">
              <thead>
                <tr class="bg-gray-100 text-gray-700">
                  <th class="px-3 py-2">วันที่ตรวจเช็ค</th>
                  <th class="px-3 py-2">รายละเอียดที่พบ</th>
                  <th class="px-3 py-2">ชั้น</th>
                  <th class="px-3 py-2">ชื่อผู้ตรวจเช็ค-ผู้พบเจอ</th>
                  <th class="px-3 py-2">สถานะ</th>
                  <th class="px-3 py-2">Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- List Tab (Form for general users) -->
      <section id="tab-list" class="tab-panel hidden">
        <div class="rounded-xl bg-white shadow-lg p-6">
          <h3 class="text-lg font-semibold">ฟอร์มการตรวจเช็ค SOC</h3>
          <form id="socForm" class="mt-4" enctype="multipart/form-data">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- วันที่ตรวจเช็ค -->
              <div>
                <label class="text-sm text-gray-600">วันที่ตรวจเช็ค</label>
                <div class="relative mt-1">
                  <input type="date" name="date" id="date" class="w-full border rounded-lg px-3 py-2 pr-10" required>
                  <div class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#9CA3AF"><path d="M7 10h5v5H7z"/><path d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 00-2 2v13a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm0 15H5V9h14v10z"/></svg>
                  </div>
                </div>
              </div>
              <!-- ชั้น -->
              <div>
                <label class="text-sm text-gray-600">ชั้น</label>
                <select name="floor" id="floor" class="w-full border rounded-lg px-3 py-2" required>
                  <option value="">-- เลือกชั้น --</option>
                  <option>ชั้น9</option><option>ชั้น8</option><option>ชั้น7</option><option>ชั้น6</option><option>ชั้น5</option>
                  <option>ชั้น4</option><option>ชั้น3</option><option>ชั้น2</option><option>ชั้น1</option><option>Packer</option>
                  <option>Pallet</option><option>อื่นๆ</option>
                </select>
              </div>
              <!-- รายละเอียดที่พบ -->
              <div class="md:col-span-2">
                <label class="text-sm text-gray-600">รายละเอียดที่พบ</label>
                <textarea name="detail" id="detail" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="ระบุรายละเอียดที่เกิด soc…" required></textarea>
              </div>
              <!-- ผู้ตรวจเช็ค/ผู้พบเจอ -->
              <div>
                <label class="text-sm text-gray-600">ชื่อผู้ตรวจเช็ค-ผู้พบเจอ</label>
                <select name="reporter" id="reporter" class="w-full border rounded-lg px-3 py-2" required>
                  <option value="">-- เลือกผู้พบเจอ --</option>
                  <option>Operation</option><option>Local</option><option>แม่บ้าน</option><option>Am</option><option>ซ่อม</option><option>อื่นๆ</option>
                </select>
              </div>
              <!-- แนบไฟล์ -->
              <div>
                <label class="text-sm text-gray-600">แนบไฟล์ (PDF, JPG, PNG)</label>
                <input type="file" name="file" id="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full border rounded-lg px-3 py-2">
              </div>
            </div>

            <div class="mt-6 flex gap-3">
              <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">ส่งคำขอ</button>
              <button type="reset" class="px-4 py-2 rounded-xl bg-gray-200 text-gray-700 hover:bg-gray-300">ยกเลิก</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Admin Tab -->
      <section id="tab-admin" class="tab-panel hidden">
        <div class="rounded-xl bg-white shadow-lg p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">ล็อคอินเข้าสู่ระบบ Admin</h3>
            <div class="text-sm" id="admin-status">สถานะ: <span class="font-semibold text-red-600">Guest</span></div>
          </div>

          <!-- Login Row -->
          <div class="mt-4 flex gap-3 items-end">
            <div class="flex-1">
              <label class="text-sm text-gray-600">รหัสผ่าน Admin</label>
              <input type="password" id="admin-pass" class="w-full border rounded-lg px-3 py-2" placeholder="ใส่รหัส: admin123" />
            </div>
            <button id="btn-admin-login" class="px-4 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600">ล็อคอิน</button>
            <button id="btn-admin-logout" class="px-4 py-2 rounded-xl bg-gray-200 text-gray-700 hover:bg-gray-300 hidden">ออกจากระบบ</button>
          </div>

          <!-- Editor (visible for Admin) -->
          <div id="admin-editor" class="mt-6 hidden">
            <div class="text-sm text-gray-600 mb-3">สิทธิ์ Admin สามารถแก้ไข/อัปเดตสถานะทั้งหมดจากตารางที่แท็บ Dashboard</div>
            <div class="rounded-lg bg-violet-50 border border-violet-200 p-4 text-sm">
              อัปเดตสถานะ: กำหนดชื่อผู้อัปเดตเป็น <span class="font-semibold">Admin วอ</span>, <span class="font-semibold">Admin Operation</span>, หรือ <span class="font-semibold">Admin ซ่อม</span> ภายใน Modal
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold" id="modal-title">รายละเอียด</h3>
        <button id="modal-close" class="text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      <div class="mt-4 space-y-3" id="modal-body">
        <!-- Filled by JS -->
      </div>
      <div class="mt-6 flex justify-end gap-3">
        <button id="modal-cancel" class="px-4 py-2 rounded-xl bg-gray-200 text-gray-700 hover:bg-gray-300">ปิด</button>
        <button id="modal-save" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">บันทึก</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-white border-t mt-8">
    <div class="max-w-6xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
      © 2025 Soc App พัฒนาโดย วรวิทย์ ศรีรักษา
    </div>
  </footer>

  <script>
    // ======= Config =======
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbyM-zK5baVOPBl1P_UKk59Sm2KFYaHjRrtDun2b63OtirNZ4-7RmDBCIRBfsPZETg-L/exec";
    const SHEET_ID = "1CVktJUFaYVQpLHHDiKDFanZzjx5J_BxQzMnTKwnLD48";
    const DRIVE_FOLDER_ID = "170CE-whM4WsW4vtmgdJVNMam0oELQAsh";

    // ======= State =======
    let socData = JSON.parse(localStorage.getItem("socData") || "[]");
    let admin = JSON.parse(localStorage.getItem("admin") || "null"); // {name: 'Admin วอ'|'Admin Operation'|'Admin ซ่อม', isLoggedIn: true}

    // ======= Helpers =======
    function saveState() {
      localStorage.setItem("socData", JSON.stringify(socData));
    }
    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      return dt.toISOString().slice(0,10);
    }
    function renderCards() {
      const total = socData.length;
      const pending = socData.filter(x => (x.status||'รอดำเนินการ') === 'รอดำเนินการ').length;
      const done = socData.filter(x => x.status === 'เสร็จสิ้น').length;
      $("#card-total").text(total);
      $("#card-pending").text(pending);
      $("#card-done").text(done);
    }
    function top5Floors() {
      const counts = {};
      socData.forEach(x => {
        const f = x.floor || "อื่นๆ";
        counts[f] = (counts[f]||0)+1;
      });
      return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
    }
    function renderTop5() {
      const list = $("#top5").empty();
      top5Floors().forEach(([floor, cnt])=>{
        list.append(`<li><span class="font-medium">${floor}</span> - ${cnt} รายการ</li>`);
      });
    }
    function renderAdminStatus() {
      if (admin && admin.isLoggedIn) {
        $("#admin-status").html('สถานะ: <span class="font-semibold text-emerald-600">Admin</span>');
        $("#btn-admin-login").addClass("hidden");
        $("#btn-admin-logout").removeClass("hidden");
        $("#admin-editor").removeClass("hidden");
      } else {
        $("#admin-status").html('สถานะ: <span class="font-semibold text-red-600">Guest</span>');
        $("#btn-admin-login").removeClass("hidden");
        $("#btn-admin-logout").addClass("hidden");
        $("#admin-editor").addClass("hidden");
      }
    }
async function syncFromSheet() {
  try {
    $.LoadingOverlay("show");
    const res = await fetch(`${GAS_EXEC_URL}?mode=list`);
    const json = await res.json();
    if (json.ok) {
      // map ข้อมูลจากชีต -> โครงสร้างที่ตารางใช้
      socData = (json.rows || []).map(r => ({
        id: r.id,
        date: r.date ? new Date(r.date).toISOString().slice(0,10) : "",
        detail: r.detail || "",
        floor: r.floor || "",
        reporter: r.reporter || "",
        status: r.status || "รอดำเนินการ",
        fileUrl: r.fileUrl || "",
        updater: r.updater || ""
      }));
      saveState();
      rebuildTable();
      renderCards();
      renderTop5();
    } else {
      console.error(json);
      Swal.fire('โหลดข้อมูลจากชีตไม่สำเร็จ', '', 'error');
    }
  } catch (e) {
    console.error(e);
    Swal.fire('เกิดข้อผิดพลาดในการโหลดข้อมูล', '', 'error');
  } finally {
    $.LoadingOverlay("hide");
  }
}

    // ======= Tabs =======
    function activateTab(selector) {
      $(".tab-panel").addClass("hidden");
      $(".tab-btn").removeClass("tab-active");
      $(selector).removeClass("hidden");
      $(`[data-target='${selector}']`).addClass("tab-active");
    }
    $("#tabs").on("click", ".tab-btn", function(){
      const target = $(this).data("target");
      activateTab(target);
    });

    // ======= DataTable =======
    let table;
    function rebuildTable() {
      if (table) table.destroy();
      const tbody = $("#socTable tbody").empty();
      socData.forEach((row, idx)=>{
        const actions = `
          <div class="flex gap-2">
            <button class="btn-view px-3 py-1 rounded-lg bg-sky-100 text-sky-700" data-index="${idx}">ดู</button>
            <button class="btn-edit px-3 py-1 rounded-lg bg-amber-100 text-amber-700" data-index="${idx}">แก้ไข</button>
            <button class="btn-del px-3 py-1 rounded-lg bg-rose-100 text-rose-700" data-index="${idx}">ลบ</button>
          </div>`;
        const status = row.status || "รอดำเนินการ";
        tbody.append(`<tr>
          <td class="px-3 py-2">${fmtDate(row.date)}</td>
          <td class="px-3 py-2">${$("<div>").text(row.detail).html()}</td>
          <td class="px-3 py-2">${row.floor||""}</td>
          <td class="px-3 py-2">${row.reporter||""}</td>
          <td class="px-3 py-2">${status}</td>
          <td class="px-3 py-2">${actions}</td>
        </tr>`);
      });
      table = new DataTable('#socTable', {
        responsive: true,
        order: [[0, 'desc']],
        language: {
          url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/th.json"
        }
      });
    }

    // ======= Date filter (day/week/month) =======
    function applyDateFilter() {
      const mode = $("#date-filter").val();
      const anchor = $("#date-anchor").val();
      if (mode === 'all' || !anchor) {
        table.search("").draw();
        return;
      }
      const base = new Date(anchor);
      function inRange(d) {
        const td = new Date(d);
        if (mode==='day') {
          return td.toDateString() === base.toDateString();
        } else if (mode==='week') {
          const diff = (td - base) / (1000*60*60*24);
          return diff <= 3 && diff >= -3; // approx 7-day window
        } else if (mode==='month') {
          return td.getMonth()===base.getMonth() && td.getFullYear()===base.getFullYear();
        }
        return true;
      }
      // custom filter
      table.rows().every(function(){
        const d = this.data()[0];
        const show = inRange(d);
        $(this.node()).toggle(show);
      });
    }
    $("#date-filter, #date-anchor").on("change", applyDateFilter);

    // ======= Modal =======
    let editingIndex = null;
    function openModal(title, bodyHtml) {
      $("#modal-title").text(title);
      $("#modal-body").html(bodyHtml);
      $("#modal").removeClass("hidden").addClass("flex");
    }
    function closeModal() {
      $("#modal").addClass("hidden").removeClass("flex");
      editingIndex = null;
    }
    $("#modal-close, #modal-cancel").on("click", closeModal);

    // ======= Actions (view/edit/delete) =======
    $("#socTable").on("click", ".btn-view", function(){
      const i = +$(this).data("index");
      const row = socData[i];
      const html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><div class="text-gray-500 text-xs">วันที่ตรวจเช็ค</div><div class="font-medium">${fmtDate(row.date)}</div></div>
          <div><div class="text-gray-500 text-xs">ชั้น</div><div class="font-medium">${row.floor}</div></div>
          <div class="md:col-span-2"><div class="text-gray-500 text-xs">รายละเอียด</div><div class="font-medium whitespace-pre-wrap">${$("<div>").text(row.detail).html()}</div></div>
          <div><div class="text-gray-500 text-xs">ผู้พบเจอ</div><div class="font-medium">${row.reporter}</div></div>
          <div><div class="text-gray-500 text-xs">สถานะ</div><div class="font-medium">${row.status||'รอดำเนินการ'}</div></div>
          ${row.fileUrl? `<div class="md:col-span-2"><a class="text-indigo-600 underline" href="${row.fileUrl}" target="_blank">ไฟล์แนบ</a></div>`: ''}
        </div>`;
      openModal("ดูรายละเอียด", html);
      $("#modal-save").addClass("hidden");
    });

    $("#socTable").on("click", ".btn-edit", function(){
      const i = +$(this).data("index");
      const row = socData[i];
      editingIndex = i;
      const isAdmin = admin && admin.isLoggedIn;
      const html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600">วันที่ตรวจเช็ค</label>
            <input type="date" id="m_date" class="w-full border rounded-lg px-3 py-2" value="${fmtDate(row.date)}" ${!isAdmin?'disabled':''}>
          </div>
          <div>
            <label class="text-sm text-gray-600">ชั้น</label>
            <select id="m_floor" class="w-full border rounded-lg px-3 py-2" ${!isAdmin?'disabled':''}>
              ${["ชั้น9","ชั้น8","ชั้น7","ชั้น6","ชั้น5","ชั้น4","ชั้น3","ชั้น2","ชั้น1","Packer","Pallet","อื่นๆ"].map(f=>`<option ${f===row.floor?'selected':''}>${f}</option>`).join("")}
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-gray-600">รายละเอียด</label>
            <textarea id="m_detail" rows="3" class="w-full border rounded-lg px-3 py-2" ${!isAdmin?'disabled':''}>${$("<div>").text(row.detail).html()}</textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600">ผู้พบเจอ</label>
            <select id="m_reporter" class="w-full border rounded-lg px-3 py-2" ${!isAdmin?'disabled':''}>
              ${["Operation","Local","แม่บ้าน","Am","ซ่อม","อื่นๆ"].map(n=>`<option ${n===row.reporter?'selected':''}>${n}</option>`).join("")}
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-600">สถานะ</label>
            <select id="m_status" class="w-full border rounded-lg px-3 py-2">
              ${["รอดำเนินการ","เสร็จสิ้น"].map(s=>`<option ${s===(row.status||'รอดำเนินการ')?'selected':''}>${s}</option>`).join("")}
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-gray-600">ชื่อผู้อัปเดตสถานะ</label>
            <select id="m_updater" class="w-full border rounded-lg px-3 py-2">
              ${["Admin วอ","Admin Operation","Admin ซ่อม"].map(u=>`<option ${u===(row.updater||'')?'selected':''}>${u}</option>`).join("")}
            </select>
          </div>
          ${row.fileUrl? `<div class="md:col-span-2"><a class="text-indigo-600 underline" href="${row.fileUrl}" target="_blank">ไฟล์แนบ</a></div>`: ''}
        </div>`;
      openModal("แก้ไขรายการ (Admin)", html);
      $("#modal-save").removeClass("hidden");
      if (!(admin && admin.isLoggedIn)) {
        $("#modal-save").prop("disabled", true).addClass("opacity-50 cursor-not-allowed");
      } else {
        $("#modal-save").prop("disabled", false).removeClass("opacity-50 cursor-not-allowed");
      }
    });

    $("#socTable").on("click", ".btn-del", function(){
      const i = +$(this).data("index");
      Swal.fire({
        title: 'ยืนยันการลบ?',
        text: 'คุณต้องการลบรายการนี้ใช่หรือไม่',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ลบ',
        cancelButtonText: 'ยกเลิก'
      }).then(res => {
        if (res.isConfirmed) {
          socData.splice(i,1);
          saveState();
          rebuildTable();
          renderCards();
          renderTop5();
          Swal.fire('ลบแล้ว', '', 'success');
        }
      });
    });

    $("#modal-save").on("click", function(){
      if (editingIndex===null) return;
      const r = socData[editingIndex];
      r.date = $("#m_date").val();
      r.floor = $("#m_floor").val();
      r.detail = $("#m_detail").val();
      r.reporter = $("#m_reporter").val();
      r.status = $("#m_status").val();
      r.updater = $("#m_updater").val();
      saveState();
      closeModal();
      rebuildTable();
      renderCards();
      renderTop5();
      Swal.fire('บันทึกสำเร็จ', '', 'success');
    });

    // ======= Admin login =======
    $("#btn-admin-login").on("click", function(){
      const pass = $("#admin-pass").val();
      if (pass === "admin123") {
        admin = {isLoggedIn: true, name: "Admin"};
        localStorage.setItem("admin", JSON.stringify(admin));
        renderAdminStatus();
        Swal.fire('ล็อคอินสำเร็จ', '', 'success');
      } else {
        Swal.fire('รหัสผ่านไม่ถูกต้อง', '', 'error');
      }
    });
    $("#btn-admin-logout").on("click", function(){
      admin = null;
      localStorage.removeItem("admin");
      renderAdminStatus();
      Swal.fire('ออกจากระบบแล้ว', '', 'success');
    });

    // ======= Form submit =======
    $("#socForm").validate({
      rules: {
        date: { required: true },
        detail: { required: true, minlength: 3 },
        floor: { required: true },
        reporter: { required: true }
      },
      submitHandler: function(form, e){
        e.preventDefault();
        const fd = new FormData();
        const data = {
          date: $("#date").val(),
          detail: $("#detail").val(),
          floor: $("#floor").val(),
          reporter: $("#reporter").val(),
          status: "รอดำเนินการ"
        };
        fd.append("payload", JSON.stringify(data));
        const file = $("#file")[0].files[0];
        if (file) fd.append("file", file);

        $.LoadingOverlay("show");
        fetch(GAS_EXEC_URL, { method: "POST", body: fd })
          .then(r=>r.json())
          .then(res=>{
            // res: { ok:true, row: {...}, fileUrl?:string }
            const row = Object.assign({}, data, { id: res.id || Date.now(), fileUrl: res.fileUrl || "" });
            socData.push(row);
            saveState();
            rebuildTable();
            renderCards();
            renderTop5();
            Swal.fire('ส่งคำขอเรียบร้อย', '', 'success');
            $("#socForm")[0].reset();
          })
          .catch(err=>{
            console.error(err);
            Swal.fire('เกิดข้อผิดพลาดในการส่งข้อมูล', '', 'error');
          })
          .finally(()=>$.LoadingOverlay("hide"));
      }
    });

    // ======= Download Excel (Single button) =======
   $("#btn-download-xlsx").on("click", function () {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=xlsx`;
  window.open(url, "_blank");
    });

    // ======= Init =======
    $(function(){
      activateTab("#tab-dashboard");
      rebuildTable();
      renderCards();
      renderTop5();
      renderAdminStatus();
      const today = new Date().toISOString().slice(0,10);
      $("#date-anchor").val(today);
      $("#date").val(today);
        // โหลดข้อมูลจาก Google Sheet
  syncFromSheet();
});
  </script>
</body>
</html>
